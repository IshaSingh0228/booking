pipeline{
   agent any
   
   triggers{
        pollSCM('* * * * *')
    }
   
   tools{
       maven 'maven3'
       jdk 'jdk11'
   }
  stages {
          stage("build & SonarQube analysis") {
            agent any
            steps {
            script{
            last_started=env.STAGE_NAME
            }
              withSonarQubeEnv('sonar-server') {
                bat 'java -version'
                bat 'mvn clean test sonar:sonar'
         
              }
            }
          }
          
          stage('package'){
          steps{
          bat 'mvn package'
          }
}    
    stage("collect artifact"){
    steps{
    script{
            last_started=env.STAGE_NAME
            }
     archiveArtifacts artifacts:'target/*.jar', followSymlinks:false
    }
    }
    stage("Quality Gate Check") {
            steps {
            script{
            last_started=env.STAGE_NAME
            }
              timeout(time: 1, unit: 'HOURS') {
                waitForQualityGate abortPipeline: true
                
              }
            }
          }
    
    stage("Uploading to artifactory"){
    steps{
    script{
            last_started=env.STAGE_NAME
            }
    rtUpload (
    serverId: 'ARTIFACTORY_SERVER',
    spec: '''{
          "files": [
            {
              "pattern": "target/*.jar",
              "target": "art-doc-dev-loc"
            }
         ]
    }''',
)
}}

stage("Downloading from artifactory"){
steps{
script{
last_started=env.STAGE_NAME
}
rtDownload (
    serverId: 'Artifactory-1',
    spec: '''{
          "files": [
            {
              "pattern": "art-doc-dev-loc/",
              "target": "war_package_download/"
            }
          ]
    }''',

}
}
}

}
post{
failure {  
             mail bcc: '', body: "<b>Failure</b><br>Project: ${env.JOB_NAME} <br>Build Number: ${env.BUILD_NUMBER} <br>Stage Name: $last_started <br> URL de build: ${env.BUILD_URL}", cc: '', charset: 'UTF-8', from: '', mimeType: 'text/html', replyTo: '', subject: "ERROR CI: Project name -> ${env.JOB_NAME}", to: "thesinghanias@gmail.com";  
         }  
  
}
}
